# taracyc_results.R
# Harjyot and Heather, Nov 2018
# Taracyc Ocean Virus Analysis  


# This script analyzes the loaded and cleaned data from the data/taracyc_data_cleaned.csv 
# and create a results errorbar plot with the mean DNA abundance levels for each pathway and depth 
# This script takes in two arguments, the input and output.
# The input is the name of the cleaned data csv file
# The output is the name of the newly generated results figure, 
# stored in the figures folder within the results folder


# Usage: Rscript src/taracyc_results.R data/taracyc_data_cleaned.csv results/figures/fig7_results.png 

#Load Librarries
suppressPackageStartupMessages(library(tidyverse))

# Read in command line arguments
args <- commandArgs(trailingOnly = TRUE)
input <- args[1]
output <- args[2]


# define main function
main <- function() {
  
  
  #Read data
  wrangled_data <- read.csv(input)
  
  #set alpha to 0.05
  alpha = 0.05
  
  #create plots with means and confidence intervals
  results <- wrangled_data %>%
    group_by(LEVEL1, DEPTH) %>% 
    summarize(mean_RPKM = mean(RPKM),
              se= sd(RPKM)/sqrt(length(RPKM))) %>%
    ggplot(aes(x = LEVEL1)) +
    geom_point(aes(y = mean_RPKM),color="red") +
    facet_wrap(~DEPTH,ncol=1) +
    geom_errorbar(aes(ymin = mean_RPKM + qnorm(alpha/2)*se,
                      ymax = mean_RPKM - qnorm(alpha/2)*se),
                  colour = "red",
                  width  = 0.2) +
    labs(x="Biological Pathways",
         y="Mean RPKM (Reads Per Kilobase Millions)",
         caption="\n
         Figure 6: Mean abundance of viral dna sequences for 20 groups created by interaction of two factors. 
         Viral DNA Sequences interact in five metabolomic pathways namely, Metabolic-Clusters, Energy-Metabolsim, 
         Detoxification, Degradation and Biosynthesis and are found at four different depths, DCM (Deep Chlorophyll 
         Maximum), MES (Mesopelagic),MIX (Marine Epipelagic Mixed Layer) and SRF(Surface Water Layer). Error bars 
         represent 95% confidence intervals generated by Standard Normal distribution.")+
    theme_classic()+
    theme(aspect.ratio = .1)+
    theme(plot.title = element_text(hjust = 0.5),
          plot.caption=element_text(hjust = 0.5))
    
  
  # Saving plot
  suppressMessages(
    ggsave(filename=output,plot=results,height=5))
}

# call main function
main()
